<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    
    <div id="serverConnected">Server : </div>
    <div id="serverConnection">
        <div>ws://wsgame-production.up.railway.app/:8080</div>
        <label>socket server : </label>
        <input type="text" id="inputServerAddress" value="ws://localhost:8080">
        <button id="btnConnect">Connect</button>
        <br>
    </div>

    <h2>Game ID : <div id="txtGameId"> Not Joined </div></h2>

    <h4>Games List:</h4>
    <table id="gamesTable">
        <thead>
            <tr>
                <th scope="col">Name</th>
                <th scope="col">Players</th>
                <th scope="col"></th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Example Game</td>
                <td>5/8</td>
                <td><button>JOIN</button></td> 
            </tr>
        </tbody>
    </table>

    <input type="text" id="inputGameId" value="untitled">
    <button id="btnCreate">New Game</button>
    <br>

    <canvas id="c" width="640" height="480" onmousedown="OnDragCanvas(event)"></canvas>

    <div id="txtCursorPos">x, y</div>

    <script>
        let clientId = null
        let gameId = null
        let ws = null
        // HTML elements
        const btnConnect = document.getElementById("btnConnect")
        const btnCreate = document.getElementById("btnCreate");
        const btnJoin = document.getElementById("btnJoin");
        const txtGameId = document.getElementById("txtGameId");
        const inputGameName = document.getElementById("inputGameId");
        const inputServerAddress = document.getElementById("inputServerAddress");

        JoinGame = function(g)
        {
            const payLoad = {
                "method": "join",
                "clientId": clientId,
                "gameId": g
            }

            ws.send(JSON.stringify(payLoad));
        }

        btnConnect.addEventListener("click", e=> {
            const serverAddress = inputServerAddress.value;
            ws = new WebSocket(serverAddress);

            document.getElementById("serverConnection").remove();
            document.getElementById("serverConnected").innerText += " " + serverAddress;

              // recieve packets
            ws.onmessage = message => {
                const response = JSON.parse(message.data);
                if (response.method === "connect"){
                    clientId = response.clientId;
                    console.log("Client id set successfully " + clientId);
                }

                if (response.method === "create"){
                    game = response.game;
                    gameId = game.id;
                    console.log("Game successfully created with id " + game.id);
                    console.log(response);
                    txtGameId.innerText = gameId;
                    inputGameId.value = gameId;
                }

                if (response.method === "gamesList"){
                    games = response.games; 
                    console.log("Games list updated" + games);

                    const gamesTable = document.getElementById("gamesTable");
                    while(gamesTable.rows.length > 1) gamesTable.deleteRow(1);

                    for(let gameId_list_element in games){
                        var row = gamesTable.insertRow(-1);

                        var cell1 = row.insertCell(0);
                        var cell2 = row.insertCell(1);
                        var cell3 = row.insertCell(2);
                        
                        var joinBtn = document.createElement("button");
                        joinBtn.innerText = "JOIN";
                        joinBtn.addEventListener("click", e => JoinGame(gameId_list_element))

                        cell1.innerText = gameId_list_element;
                        cell2.innerText = "   " + Object.keys(games[gameId_list_element].clients).length;
                        cell3.appendChild(joinBtn);
                    }
                }

                if (response.method === "join"){
                    game = response.game;    
                    gameId = game.id;
                    console.log("someone joined the game ");
                    console.log(response);
                    txtPlayers.innerText = game.clients.length + " Players Joined";
                    txtGameId.innerText = gameId;

                    while(txtPlayers.firstChild) 
                        txtPlayers.removeChild(txtPlayers.firstChild);
                }

                if (response.method === "move"){
                    game = response.game;
                    console.log(game);
                }
            }
        })

        //wiring events
        btnCreate.addEventListener("click", e => {
            const payLoad = {
                "method": "create",
                "clientId": clientId,
                "gameId": inputGameId.value
            }
            ws.send(JSON.stringify(payLoad));
        })
      
    </script>
</body>
</html>

<!-- Shaders -->

<script  id="direct-vertex-shader" type="notjs">

    // an attribute will receive data from a buffer
    attribute vec4 a_position;
    uniform mat4 u_MMat;
    uniform mat4 u_VMat;
  
    varying vec4 color;
  
    // all shaders have a main function
    void main() 
    {
      gl_Position = u_VMat * (u_MMat * a_position);
      color = vec4(1.0, 1.0, 1.0, 1.0);
    }
  
</script>
  
<script  id="fragment-shader" type="notjs">
  
    // fragment shaders don't have a default precision so we need to pick one.
    precision lowp float;
  
    varying vec4 color;
  
    void main() {

      gl_FragColor = color; 
    }
</script>

<!-- Text Rendering Shaders -->

<script  id="text-vertex-shader" type="notjs">

    // an attribute will receive data from a buffer
    attribute vec4 a_position;

    uniform mat4 u_MMat;
    uniform mat4 u_VMat;

    varying vec2 v_texCoord;
  
    // all shaders have a main function
    void main() 
    {
      vec4 screenPos = u_VMat * (u_MMat * a_position);
      gl_Position = screenPos;
      v_texCoord = screenPos.xy;
    }
  
</script>
  
<script  id="text-fragment-shader" type="notjs">
    precision lowp float;
  
    varying vec2 v_texCoord;

    uniform sampler2D u_texture;
  
    void main() 
    {
      gl_FragColor = texture2D(u_texture, v_texCoord); 
      //gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
    }
</script>
  

<!-- > RUN APP AFTER EVERYTHING ELSE IS LOADED <!-->
<script src="linalg.js"></script>
<script src="initializeGame.js"></script>
<script src="meshdata.js"></script>
<script src="engineClasses.js"></script>
<script src="app.js"></script>